{% extends 'base.html' %}
{% load static %}

{% block header %}
<link rel="stylesheet" href="{% static 'css/profile_2.css' %}">
{% endblock header %}

{% block content %}
		<div style="background-color: #F5F5F5;" class="col-md-offset-2 col-10 col-lg-offset-3">
    	 <div class="well profile">
            <div class="col-sm-12" style="display: flex;">
                <div class="col-xs-12 col-sm-8">
                    <h2>{{ user.first_name }} {{ user.last_name }}</h2>
                    <p><strong>About: </strong>{{ user.profile.bio }}</p>
                    <p><strong>Hobbies: </strong> Read, out with friends, listen to music, draw and learn new things. </p>
                    <p><strong>Address: </strong></p>
                </div>             
                <div class="col-xs-12 col-sm-4 text-center">
                    <figure>
                        <img src="{{ user.profile.image.url }}" width="150" height="150" alt="" class="image-circle img-circle img-responsive">
                        <div class="image-text-box"><p>@{{ user.username }}</p></div>
                    </figure>
                </div>
            </div>            
            <div class="col-xs-12 divider text-center">
                <div class="col-xs-12 col-sm-4 mt-2">
                    <h2><strong><span class="follow-count-span">{{ followers_count }}</span></strong></h2>                    
                    <p><small>Followers</small></p>
                    {% if not owner %}
                    {% if not follows %}
                    <button id="follow-btn" class="btn btn-success btn-block"><span class="fa fa-plus-circle"></span>
                        {% if follows %}Unfollow{% else %}Follow{% endif %}
                    </button>
                    {% else %}
                    <button id="follow-btn" class="btn btn-indigo btn-block"><span class="fa fa-plus-circle"></span>
                        {% if follows %}Unfollow{% else %}Follow{% endif %}
                    </button>
                    {% endif %}
                    {% endif %}
                </div>
                <div class="col-xs-12 col-sm-4 mt-2">
                    <h2><strong>{{ following_count }}</strong></h2>                    
                    <p><small>Following</small></p>
                    {% if not owner %}
                    <button class="btn btn-info m-0" data-chatid="{{ user.id }}" onclick="userAddChat(this)"><span class="fa fa-user"></span> Message</button>
                    {% endif %}
                </div>
                <div class="col-xs-12 col-sm-4 mt-2">
                    <h2><strong>{{ request.user.content.count }}</strong></h2>                    
                    <p><small>Posts</small></p>
                    {% if owner %}
                    <div class="btn-group">
                        <button type="button" onclick="editProfile()" class="btn btn-primary">
                            <span class="fa fa-pencil-alt mr-2"></span> Edit </button>
                    </div>
                    {% endif %}
                </div>
         </div>    
         <div class="col-xs-12 text-center divider mt-4">             
                <div class="col-sm-4 emphasis"><a href="#">Latest Posts</a></div>
                <div class="col-sm-4 emphasis" ><a href="#">Mentions</a></div>
                <div class="col-sm-4 emphasis"><a href="#">Images & Videos</a></div>
        </div>
		</div>

{% endblock content %}

{% block js %}

<script type="text/javascript">
    function editProfile(){
        window.location.href = '{% url "edit_profile" %}'
    }
    
    var followBtn = document.getElementById("follow-btn")
    if(followBtn != null){
        followBtn.addEventListener('click', function(){
        var currentState = followBtn.innerText
        if (currentState.includes('UNFOLLOW')){
            var action = 'Unfollow'
        }else{
            var action = 'Follow'
        }
        
        var user_id = '{{user.id}}'
        var request_user_id = '{{request_user_id}}'
        var url = 'follow_unfollow/'
        fetch(url, {
        method:'POST',
        headers:{
            "Content-Type":'application/json',
            "X-CSRFToken":csrftoken,
        },
        body:JSON.stringify({
            'request_user_id':request_user_id,
            'user_id':user_id,
            'action':action
            })
        })
        .then((resp) => {
            return resp.json()
        })
        .then((response)=>{
            console.log(response)
            if (response.status == 'success'){
                
                var followSpan = document.getElementsByClassName('follow-count-span')[0]
                var prevState = parseInt(followSpan.innerText)
                console.log(prevState)
                if(followBtn.innerText.includes('UNFOLLOW')){
                    followBtn.innerHTML = `<span class="fa fa-plus-circle"></span> Follow`
                    followBtn.classList.add('btn-success')
                    followBtn.classList.remove('btn-indigo')
                    followSpan.innerText = prevState - 1
                }else{
                    console.log('action')
                    followBtn.innerHTML = `<span class="fa fa-plus-circle"></span> Unfollow`
                    followBtn.classList.add('btn-indigo')
                    followBtn.classList.remove('btn-success')
                    followSpan.innerText = prevState + 1
                }
            }
        })
    })
    }
    function userAddChat(e){
        var id = e.dataset.chatid
        console.log(id)

        $.get('/chat/create/new/', {'userid': id},   function(data){
            if (data['success'] == true){
                window.location.href = `/chat/${id}`   
            }else{
                alert('something went wrong!! please try again...')
            }
        })
    }
    
</script>

{% endblock js %}